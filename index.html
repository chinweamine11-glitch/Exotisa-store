<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Exotisa Store</title>

<!-- Material -->
<link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Three.js -->
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

<style>
body{margin:0;font-family:Roboto;background:#0b0b0b;color:#fff}
header{padding:16px;background:#111;display:flex;justify-content:space-between}
.card{background:#1a1a1a;border-radius:16px;padding:16px;width:240px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,240px);gap:16px}
button{padding:8px 12px;border-radius:8px}
</style>
</head>

<body>

<header>
  <h2>ðŸ›’ Exotisa Store</h2>
  <div id="authArea"></div>
</header>

<canvas id="bg"></canvas>

<main>
  <input id="search" placeholder="ðŸ” Ø¨Ø­Ø« Ø°ÙƒÙŠ" oninput="smartSearch(this.value)">
  <div id="apps" class="grid"></div>
</main>

<script>
/* ================= SUPABASE ================= */
const supabase = supabaseJs.createClient(
 "https://qjfpkwyglveukzfazmzo.supabase.co",
 "YOUR_PUBLIC_ANON_KEY"
);

/* ================= AUTH ================= */
async function loginGoogle(){
 await supabase.auth.signInWithOAuth({
  provider:"google",
  options:{redirectTo:location.origin}
 });
}

async function signup(){
 const email=prompt("Email");
 const pass=prompt("Password");
 await supabase.auth.signUp({
  email,password:pass,
  options:{emailRedirectTo:location.origin}
 });
 alert("ðŸ“§ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ");
}

async function resetPassword(){
 const email=prompt("Email");
 await supabase.auth.resetPasswordForEmail(email,{
  redirectTo:location.origin
 });
 alert("ðŸ“© Ø£ÙØ±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹");
}

supabase.auth.onAuthStateChange(async(e,s)=>{
 if(!s){ 
  authArea.innerHTML=`
   <button onclick="signup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
   <button onclick="loginGoogle()">Google</button>
   <button onclick="resetPassword()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>`;
  return;
 }

 if(!s.user.email_confirmed_at && !s.user.app_metadata.provider){
  alert("Ø£ÙƒØ¯ Ø¨Ø±ÙŠØ¯Ùƒ Ø£ÙˆÙ„Ø§");
  await supabase.auth.signOut();
  return;
 }

 await supabase.from("users").upsert({
  id:s.user.id,
  email:s.user.email,
  role:s.user.email==="chinweamie11@gmail.com"?"admin":"user"
 });

 authArea.innerHTML=`<button onclick="supabase.auth.signOut()">Ø®Ø±ÙˆØ¬</button>`;
 loadApps();
});

/* ================= STORE ================= */
async function loadApps(){
 const {data}=await supabase.from("apps").select("*").eq("published",true);
 apps.innerHTML="";
 data.forEach(a=>{
  apps.innerHTML+=`
  <div class="card">
   <img src="${a.icon_url}" width="80">
   <h3>${a.name}</h3>
   <p>${a.short_description||""}</p>
   <button onclick="download(${a.id},'${a.apk_path}')">â¬‡ ØªØ­Ù…ÙŠÙ„</button>
  </div>`;
 });
}

async function download(id,path){
 const u=await supabase.auth.getUser();
 if(!u.data.user){alert("Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„");return;}

 await supabase.from("downloads").insert({
  app_id:id,user_id:u.data.user.id
 });

 const {data}=await supabase.storage.from("apps").createSignedUrl(path,60);
 location.href=data.signedUrl;
}

/* ================= SEARCH ================= */
async function smartSearch(q){
 if(!q){loadApps();return;}
 const {data}=await supabase
  .from("apps")
  .select("*")
  .textSearch("search",q);
 apps.innerHTML="";
 data.forEach(a=>{
  apps.innerHTML+=`<div class="card">${a.name}</div>`;
 });
}

/* ================= 3D ================= */
const scene=new THREE.Scene();
const cam=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,100);
const r=new THREE.WebGLRenderer({canvas:bg,alpha:true});
r.setSize(innerWidth,innerHeight);
const g=new THREE.IcosahedronGeometry(2);
const m=new THREE.MeshStandardMaterial({color:0x0055ff,wireframe:true});
const mesh=new THREE.Mesh(g,m);
scene.add(mesh);
cam.position.z=6;
(function anim(){
 requestAnimationFrame(anim);
 mesh.rotation.x+=0.003;
 mesh.rotation.y+=0.002;
 r.render(scene,cam);
})();
</script>
</body>
</html>
