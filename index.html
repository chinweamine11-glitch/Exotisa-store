<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exotisa Store - Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ…Ø§ Ù‡Ùˆ */
        /* Ø¬Ù…ÙŠØ¹ Ø£Ù†Ù…Ø§Ø· CSS Ù…ÙˆØ¬ÙˆØ¯Ø© - ØªÙ… Ø§Ø®ØªØµØ§Ø±Ù‡Ø§ Ù„Ù„ØªÙˆØ¶ÙŠØ­ */
        
        /* Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© */
        .input-error {
            border-color: #ef4444 !important;
        }
        .error-text {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªÙˆÙ‰ HTML Ø§Ù„Ø­Ø§Ù„ÙŠ -->
    
    <!-- ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù Ù‚Ø¨Ù„ </body> -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Supabase Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ -->
    <script>
        // ğŸ”’ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¢Ù…Ù†Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Supabase (anon key ÙÙ‚Ø·)
        const SUPABASE_URL = 'https://qjfpkwyglveukzfazmzo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqZnBrd3lnbHZldWt6ZmF6bXpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjY2MjMsImV4cCI6MjA4MzA0MjYyM30.L-bh48EGgn348UzJzBajJc1PR7-z1weW1ayzZz-tbvc';
        
        // ØªÙ‡ÙŠØ¦Ø© Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Ø¬Ø¹Ù„ supabase Ù…ØªØ§Ø­Ø§Ù‹ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
        window.supabaseClient = supabase;
    </script>
    
    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <script>
        const ExotisaApp = {
            // Ø§Ù„Ø­Ø§Ù„Ø©
            state: {
                user: null,
                apps: [],
                categories: [],
                featuredApps: [],
                currentCategory: 'all',
                sortBy: 'newest',
                page: 1,
                limit: 12,
                isLoading: false,
                hasMore: true,
                currentApp: null,
                searchSuggestions: [],
                tags: [],
                isAdmin: false,
                sessionToken: null
            },

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            async init() {
                console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Exotisa Store...');
                this.showLoading();
                
                try {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
                    await this.checkSession();
                    
                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
                    this.applyTheme();
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    await this.loadInitialData();
                    
                    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                    this.initEvents();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    this.updateUI();
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
                    if (this.state.user) {
                        document.getElementById('authLock').classList.add('unlocked');
                    }
                    
                    console.log('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²!');
                    await this.loadApps();
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                    this.showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            async loadInitialData() {
                try {
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª
                    const { data: categories, error: categoriesError } = await supabase
                        .from('categories')
                        .select('*')
                        .order('sort_order');
                    
                    if (categoriesError) throw categoriesError;
                    this.state.categories = categories || [];
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©
                    const { data: featuredApps, error: featuredError } = await supabase
                        .from('apps')
                        .select('*, categories(name, color)')
                        .eq('is_featured', true)
                        .eq('is_active', true)
                        .order('created_at', { ascending: false })
                        .limit(6);
                    
                    if (featuredError) throw featuredError;
                    this.state.featuredApps = featuredApps || [];
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø¨Ø­Ø«
                    await this.loadSearchSuggestions();
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:', error);
                    this.showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©', 'error');
                }
            },

            // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
            async login(email, password) {
                this.showLoading();
                
                try {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… query Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† RPC
                    const { data: users, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('email', email)
                        .eq('is_active', true)
                        .single();
                    
                    if (error || !users) {
                        throw new Error('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ ØªØ´ÙÙŠØ±)
                    // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ù†ÙØªØ±Ø¶ Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø®Ø²Ù†Ø© ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… crypt() ÙÙŠ PostgreSQL
                    
                    this.state.user = users;
                    this.state.isAdmin = users.role === 'admin';
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø©
                    await this.createSession(users.id);
                    
                    this.closeModal('loginModal');
                    this.updateUI();
                    document.getElementById('authLock').classList.add('unlocked');
                    this.showAlert(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ${users.full_name || users.email}`, 'success');
                    
                    await this.loadApps();
                    
                    return users;
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                    this.showAlert(error.message, 'error');
                    throw error;
                } finally {
                    this.hideLoading();
                }
            },

            // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„Ø©
            async register(email, password, fullName = null) {
                this.showLoading();
                
                try {
                    const confirmPassword = document.getElementById('registerConfirmPassword').value;
                    if (password !== confirmPassword) {
                        throw new Error('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
                    }
                    
                    if (password.length < 6) {
                        throw new Error('ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    }
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… insert Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† RPC
                    const { data, error } = await supabase
                        .from('users')
                        .insert([
                            {
                                email: email,
                                password: password, // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØ¬Ø¨ ØªØ´ÙÙŠØ± Ù‡Ø°Ø§
                                full_name: fullName,
                                role: 'user',
                                is_active: true
                            }
                        ])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    if (!data) {
                        throw new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
                    }
                    
                    this.state.user = data;
                    this.state.isAdmin = false;
                    
                    await this.createSession(data.id);
                    
                    this.closeModal('registerModal');
                    this.updateUI();
                    document.getElementById('authLock').classList.add('unlocked');
                    this.showAlert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Exotisa Store', 'success');
                    
                    return data;
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
                    this.showAlert(error.message, 'error');
                    throw error;
                } finally {
                    this.hideLoading();
                }
            },

            // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø©
            async createSession(userId) {
                try {
                    const token = this.generateToken(64);
                    const expiresAt = new Date();
                    expiresAt.setDate(expiresAt.getDate() + 30);
                    
                    const { error } = await supabase
                        .from('sessions')
                        .insert({
                            user_id: userId,
                            token: token,
                            expires_at: expiresAt.toISOString()
                        });
                    
                    if (error) throw error;
                    
                    localStorage.setItem('session_token', token);
                    localStorage.setItem('user_id', userId);
                    
                    this.state.sessionToken = token;
                    
                    return token;
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©:', error);
                    throw error;
                }
            },

            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… supabase Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† this.supabase
            // ... (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰)
            
            // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
            generateToken(length) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let token = '';
                for (let i = 0; i < length; i++) {
                    token += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return token;
            },

            showAlert(message, type = 'info') {
                const container = document.getElementById('alertContainer');
                
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(alert);
                
                setTimeout(() => {
                    alert.style.animation = 'slideIn 0.3s ease reverse forwards';
                    setTimeout(() => alert.remove(), 300);
                }, 4000);
            },

            showLoading() {
                document.getElementById('loadingOverlay').classList.add('active');
            },

            hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => ExotisaApp.init());
        window.ExotisaApp = ExotisaApp;
    </script>
</body>
</html>
